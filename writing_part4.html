<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing - Part 4</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header id="header-placeholder"></header>
    <div class="content-pusher">
        <div class="container">
            <div class="page-intro">
                <h1>Writing - Part 4</h1>
                <p>Vi·∫øt hai email ph·∫£n h·ªìi</p>
            </div>
            <!-- ƒê·∫∂T TH·∫≤NG N·ªòI DUNG V√ÄO ƒê√ÇY -->
            <div class="explanation-box">
                <h3>üí° Ph√¢n t√≠ch ƒë·ªÅ & G·ª£i √Ω √Ω t∆∞·ªüng</h3>
                <h4>Ph√¢n t√≠ch ƒë·ªÅ b√†i:</h4>
                <p>ƒê√¢y l√† d·∫°ng ƒë·ªÅ <strong>gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ & ƒë∆∞a ra g·ª£i √Ω</strong>. B·∫°n c·∫ßn ƒë√≥ng vai tr√≤ l√† m·ªôt th√†nh vi√™n t√≠ch c·ª±c, ƒë·ªÅ xu·∫•t c√°c gi·∫£i ph√°p cho m·ªôt k·∫ø ho·∫°ch c·ªßa c√¢u l·∫°c b·ªô.</p>
                <h4>G·ª£i √Ω tri·ªÉn khai √Ω t∆∞·ªüng chung:</h4>
                <ul>
                    <li><strong>T·ªï ch·ª©c s·ª± ki·ªán:</strong>
                        <ul>
                            <li>Ch·ªçn th·ªùi gian, ƒë·ªãa ƒëi·ªÉm ph√π h·ª£p.</li>
                            <li>ƒêa d·∫°ng lo·∫°i h√¨nh ho·∫°t ƒë·ªông (v√≠ d·ª•: tour ƒëi b·ªô, workshop vƒÉn h√≥a).</li>
                            <li>Qu·∫£ng c√°o s·ª± ki·ªán ƒë·ªÉ thu h√∫t ng∆∞·ªùi tham gia.</li>
                        </ul>
                    </li>
                    <li><strong>Ch·ªçn ch·ªß ƒë·ªÅ thu h√∫t:</strong>
                        <ul>
                            <li>C√≥ th·ªÉ mi·ªÖn ph√≠ v√© ho·∫∑c ch·ªçn m·ªôt ch·ªß ƒë·ªÅ th·∫≠t th√∫ v·ªã, m·ªõi l·∫°.</li>
                        </ul>
                    </li>
                     <li><strong>TƒÉng ph√≠ / G√¢y qu·ªπ:</strong>
                        <ul>
                            <li>TƒÉng ph√≠ m·ªôt c√°ch nh·∫π nh√†ng ƒë·ªÉ c√≥ th√™m ng√¢n s√°ch.</li>
                            <li>T·ªï ch·ª©c c√°c ho·∫°t ƒë·ªông g√¢y qu·ªπ ho·∫∑c k√™u g·ªçi ƒë√≥ng g√≥p t·ª± nguy·ªán.</li>
                        </ul>
                    </li>
                    <li><strong>M·ªùi kh√°ch m·ªùi:</strong>
                        <ul>
                            <li>M·ªùi m·ªôt ng∆∞·ªùi n·ªïi ti·∫øng ho·∫∑c c√≥ s·ª©c ·∫£nh h∆∞·ªüng ƒë·ªÉ chia s·∫ª.</li>
                            <li>T·ªï ch·ª©c s·ª± ki·ªán thu h√∫t c·∫£ ng∆∞·ªùi tr·∫ª v√† ng∆∞·ªùi l·ªõn tu·ªïi.</li>
                            <li><strong>V√≠ d·ª•:</strong> T·ªï ch·ª©c "S·ª± ki·ªán n√¢ng cao nh·∫≠n th·ª©c v·ªÅ an to√†n giao th√¥ng" (A road safety awareness event).</li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!-- B·∫¢NG ƒêI·ªÄU KHI·ªÇN CH·ªåN CH·ª¶ ƒê·ªÄ -->
            <div id="topic-selector-grid" class="topic-grid">
                <!-- C√°c n√∫t ch·ªçn ch·ªß ƒë·ªÅ s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </div>
            
            <main id="writing-container">
                <!-- Ch·ªâ m·ªôt b√†i t·∫≠p ƒë∆∞·ª£c hi·ªÉn th·ªã t·∫°i m·ªôt th·ªùi ƒëi·ªÉm -->
            </main>
        </div>
        <footer id="footer-placeholder"></footer>
    </div>
    <script src="js/main.js"></script>
    <script src="js/data-writing.js"></script>
<script>
                document.addEventListener('DOMContentLoaded', function () {
            const selectorContainer = document.getElementById('topic-selector-grid');
            const contentContainer = document.getElementById('writing-container');
            const topics = writingData.part4;

            topics.forEach((topic, index) => {
                const button = document.createElement('button');
                button.className = 'topic-selector-btn';
                button.textContent = `Ch·ªß ƒë·ªÅ ${index + 1}`;
                button.dataset.target = `#${topic.id}`;
                selectorContainer.appendChild(button);

                const card = document.createElement('div');
                card.className = 'quiz-card writing-part4-card';
                card.id = topic.id;

                card.innerHTML = `
                    <div class="card-header"><h2>${topic.title}</h2></div>
                    <div class="context-box"><h4>B·ªëi c·∫£nh:</h4><p>${topic.context}</p></div>
                    <!-- Nhi·ªám v·ª• 1 -->
                    <div class="writing-task" data-task-id="1">
                        <div class="task-header"><h3>Nhi·ªám v·ª• 1: Email cho b·∫°n (th√¢n m·∫≠t)</h3><p class="instruction">${topic.task1.instruction}</p></div>
                        <div class="writing-timer-bar"><button class="action-btn start-writing-btn" data-duration="600">B·∫Øt ƒë·∫ßu (10 ph√∫t)</button><div class="timer-display">10:00</div></div>
                        <textarea class="writing-textarea" data-limit="50" rows="8" placeholder="Vi·∫øt email cho b·∫°n c·ªßa b·∫°n ·ªü ƒë√¢y..."></textarea>
                        <div class="word-count-container"><span class="word-count">0/50 words</span></div>
                        <div class="card-actions"><button class="action-btn show-sample-btn">üìñ Xem email m·∫´u</button></div>
                        <div class="sample-answer-wrapper" style="display: none;"><div class="sample-answer"><pre>${topic.task1.sampleAnswer}</pre></div></div>
                    </div>
                    <!-- Nhi·ªám v·ª• 2 -->
                    <div class="writing-task" data-task-id="2">
                         <div class="task-header"><h3>Nhi·ªám v·ª• 2: Email cho qu·∫£n l√Ω (trang tr·ªçng)</h3><p class="instruction">${topic.task2.instruction}</p></div>
                         <div class="writing-timer-bar"><button class="action-btn start-writing-btn" data-duration="1200">B·∫Øt ƒë·∫ßu (20 ph√∫t)</button><div class="timer-display">20:00</div></div>
                         <textarea class="writing-textarea" data-limit="150" rows="15" placeholder="Vi·∫øt email cho qu·∫£n l√Ω ·ªü ƒë√¢y..."></textarea>
                         <div class="word-count-container"><span class="word-count">0/150 words</span></div>
                         <div class="card-actions"><button class="action-btn show-sample-btn">üìñ Xem email m·∫´u</button></div>
                         <div class="sample-answer-wrapper" style="display: none;"><div class="sample-answer"><pre>${topic.task2.sampleAnswer}</pre></div></div>
                    </div>`;
                contentContainer.appendChild(card);
            });

            const allButtons = selectorContainer.querySelectorAll('.topic-selector-btn');
            const allCards = contentContainer.querySelectorAll('.writing-part4-card');
            let timers = {};
            
            function showTopic(targetId) {
                allCards.forEach(card => card.classList.remove('active'));
                allButtons.forEach(btn => btn.classList.remove('active'));
                const targetCard = document.querySelector(targetId);
                const targetButton = selectorContainer.querySelector(`[data-target='${targetId}']`);
                if (targetCard) targetCard.classList.add('active');
                if (targetButton) targetButton.classList.add('active');
                Object.values(timers).forEach(timer => clearInterval(timer));
                allCards.forEach(c => {
                    c.querySelectorAll('.writing-timer-bar').forEach(bar => {
                        const btn = bar.querySelector('.start-writing-btn');
                        const display = bar.querySelector('.timer-display');
                        const duration = btn.dataset.duration;
                        const minutes = Math.floor(duration / 60);
                        display.textContent = `${minutes.toString().padStart(2, '0')}:00`;
                        btn.disabled = false;
                        btn.textContent = `B·∫Øt ƒë·∫ßu (${minutes} ph√∫t)`;
                    });
                });
            }
            
            function loadAnswers(card) {
                const storageKey = `writing_part4_${card.id}`;
                const saved = JSON.parse(localStorage.getItem(storageKey));
                if (saved) {
                    const task1Textarea = card.querySelector('[data-task-id="1"] textarea');
                    const task2Textarea = card.querySelector('[data-task-id="2"] textarea');
                    if(task1Textarea && saved.task1) {
                        task1Textarea.value = saved.task1;
                        task1Textarea.dispatchEvent(new Event('input'));
                    }
                    if(task2Textarea && saved.task2) {
                        task2Textarea.value = saved.task2;
                        task2Textarea.dispatchEvent(new Event('input'));
                    }
                }
            }
            allCards.forEach(loadAnswers);
            
            selectorContainer.addEventListener('click', function(e) { if (e.target.classList.contains('topic-selector-btn')) showTopic(e.target.dataset.target); });

            contentContainer.addEventListener('input', function(e) {
                if (e.target.classList.contains('writing-textarea')) {
                    const textarea = e.target;
                    const wordCountSpan = textarea.nextElementSibling.querySelector('.word-count');
                    const words = textarea.value.trim().split(/\s+/).filter(word => word.length > 0);
                    const limit = textarea.dataset.limit;
                    wordCountSpan.textContent = `${words.length}/${limit} words`;
                    wordCountSpan.classList.toggle('limit-exceeded', words.length > limit);
                    
                    const card = e.target.closest('.writing-part4-card');
                    const storageKey = `writing_part4_${card.id}`;
                    const task1Value = card.querySelector('[data-task-id="1"] textarea').value;
                    const task2Value = card.querySelector('[data-task-id="2"] textarea').value;
                    localStorage.setItem(storageKey, JSON.stringify({ task1: task1Value, task2: task2Value }));
                }
            });

            contentContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('start-writing-btn')) {
                    const button = e.target;
                    const timerBar = button.closest('.writing-timer-bar');
                    const timerDisplay = timerBar.querySelector('.timer-display');
                    const taskContainer = button.closest('.writing-task');
                    const textarea = taskContainer.querySelector('.writing-textarea');
                    const timerId = taskContainer.id;

                    if (timers[timerId]) clearInterval(timers[timerId]);
                    button.disabled = true;
                    button.textContent = 'ƒêang t√≠nh gi·ªù...';
                    let timeInSeconds = parseInt(button.dataset.duration, 10);

                    timers[timerId] = setInterval(() => {
                        timeInSeconds--;
                        const minutes = Math.floor(timeInSeconds / 60);
                        const seconds = timeInSeconds % 60;
                        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        if (timeInSeconds <= 0) {
                            clearInterval(timers[timerId]);
                            timerDisplay.textContent = "H·∫øt gi·ªù!";
                            alert(`H·∫øt gi·ªù cho nhi·ªám v·ª• n√†y!`);
                            textarea.disabled = true;
                        }
                    }, 1000);
                }
                if(e.target.classList.contains('show-sample-btn')) {
                    const wrapper = e.target.closest('.card-actions').nextElementSibling;
                    const isVisible = wrapper.style.display === 'block';
                    wrapper.style.display = isVisible ? 'none' : 'block';
                    e.target.textContent = isVisible ? 'üìñ Xem email m·∫´u' : 'üôà ·∫®n email m·∫´u';
                }
            });
            
            if (allButtons.length > 0) showTopic(allButtons[0].dataset.target);
        });
    </script>
</body>
</html>