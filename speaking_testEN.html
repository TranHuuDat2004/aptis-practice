<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aptis Speaking Practice</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="img/favicon.png" type="image/x-icon">

    <style>
        /* === CSS MỚI - TÁI TẠO GIAO DIỆN "APTIS PRACTICE" === */

        /* Cài đặt chung và layout trung tâm */
        body,
        html {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5; /* Màu nền xám nhạt */
            color: #333;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background-color: #ffffff;
            border-top: 4px solid #d9534f;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0; /* Không cho header co lại */
        }
        
        .header-left {
            font-weight: bold;
            font-size: 1.1em;
        }

        .header-center, .header-right {
            font-size: 0.95em;
            color: #555;
        }

        /* Container chính để căn giữa nội dung */
        .main-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 24px;
        }
        
        /* Box chứa nội dung thi chính */
        .test-simulation-wrapper {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 32px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 800px;
            box-sizing: border-box;
        }

        /* Ẩn/Hiện các màn hình */
        .test-screen { display: none; }
        .test-screen.active { display: block; }
        
        /* Tiêu đề chính của từng phần (VD: Speaking III) */
        #part-indicator {
            font-size: 1.8em;
            margin-top: 0;
            margin-bottom: 24px;
            color: #000;
            font-weight: 500;
        }
        
        #task-indicator { display: none; }
        
        /* Nội dung bên trong phần câu hỏi */
        .question-content {
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .question-sub-header {
            font-size: 0.9em;
            color: #666;
            margin-top: 0;
            margin-bottom: 16px;
        }

        /* Khu vực hình ảnh */
        .test-image-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
        }
        .test-image-container img {
            width: calc(50% - 10px);
            max-width: 350px;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* Text câu hỏi */
        .test-question-text {
            font-size: 1.1em;
            line-height: 1.5;
        }
        
        .test-part4-questions ul {
            list-style-type: none;
            padding-left: 0;
        }
        .test-part4-questions li {
            font-size: 1.1em;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        /* Nút Next */
        .footer-controls {
            margin-top: 24px;
            text-align: right;
        }
        
        .action-btn {
            padding: 10px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            background-color: #28a745; /* Màu xanh lá cây */
            color: white;
        }
        .action-btn:hover {
            background-color: #218838;
        }
        
        /* Ẩn timer gốc */
        #timer-area { display: none; }
        
        /* Màn hình bắt đầu và kết thúc */
        #start-screen, #end-screen {
            text-align: center;
            padding: 40px 0;
        }
    </style>
</head>

<body>
    <div class="page-wrapper">
        <!-- Header tĩnh -->
        <header class="test-header">
            <div class="header-left">Aptis Practice</div>
            <div class="header-center" id="timer-display-header">Time remaining: --:--</div>
            <div class="header-right" id="question-indicator-header">Speaking Test</div>
        </header>

        <!-- Container chính, căn giữa nội dung -->
        <main class="main-container">
            <div class="test-simulation-wrapper">
                <!-- Màn hình bắt đầu -->
                <div id="start-screen" class="test-screen active">
                    <h1>Speaking Test Simulation</h1>
                    <p>The test will proceed automatically through 4 parts. You cannot pause.</p>
                    <div class="footer-controls" style="text-align: center;">
                        <button class="action-btn" id="start-test-btn">Start Test</button>
                    </div>
                </div>

                <!-- Màn hình làm bài -->
                <div id="test-screen" class="test-screen">
                    <h2 id="part-indicator"></h2>
                    <div id="question-area">
                        <!-- JS sẽ điền nội dung vào đây -->
                    </div>
                    <div class="footer-controls">
                        <button class="action-btn" id="next-btn" style="display: none;">Next</button>
                    </div>
                    <!-- Timer ẩn -->
                    <div id="timer-area"></div>
                </div>

                <!-- Màn hình kết thúc -->
                <div id="end-screen" class="test-screen">
                    <!-- Nội dung màn hình kết thúc của bạn ở đây -->
                     <h1>Test Finished!</h1>
                     <p>Congratulations on completing the practice test.</p>
                </div>
            </div>
        </main>
    </div>
    
    <script src="js/data-speaking.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Lấy các element
        const startScreen = document.getElementById('start-screen');
        const testScreen = document.getElementById('test-screen');
        const endScreen = document.getElementById('end-screen');
        const startBtn = document.getElementById('start-test-btn');
        const partIndicator = document.getElementById('part-indicator');
        const questionArea = document.getElementById('question-area');
        const nextBtn = document.getElementById('next-btn');
        const timerDisplayHeader = document.getElementById('timer-display-header');
        const questionIndicatorHeader = document.getElementById('question-indicator-header');

        const shuffle = (array) => array.sort(() => Math.random() - 0.5);

        let timerInterval;
        let forceNext = () => {};
        let questionCounter = 0;

        function runTimer(totalSeconds, showNextButton = false) {
            return new Promise(resolve => {
                let secondsLeft = totalSeconds;
                forceNext = () => {
                    clearInterval(timerInterval);
                    nextBtn.style.display = 'none';
                    resolve();
                };
                if (showNextButton) {
                    nextBtn.style.display = 'inline-block';
                } else {
                    nextBtn.style.display = 'none';
                }
                const updateDisplay = () => {
                    const minutes = Math.floor(secondsLeft / 60);
                    const seconds = secondsLeft % 60;
                    const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    timerDisplayHeader.textContent = `Time remaining: ${formattedTime}`;
                };
                updateDisplay();
                
                timerInterval = setInterval(() => {
                    secondsLeft--;
                    updateDisplay();
                    if (secondsLeft <= 0) {
                        forceNext();
                    }
                }, 1000);
            });
        }

        // Hàm displayContent được cập nhật để tạo cấu trúc mới
        function displayContent(part, contentHTML) {
            questionCounter++;
            partIndicator.textContent = `Speaking ${part}`;
            questionArea.innerHTML = `
                <div class="question-content">
                    <p class="question-sub-header">Câu hỏi</p>
                    ${contentHTML}
                </div>
            `;
            questionIndicatorHeader.textContent = `Speaking question ${questionCounter}`;
        }
        
        async function startTest() {
            startScreen.classList.remove('active');
            testScreen.classList.add('active');
            questionCounter = 0;

            await runPart1();
            await runPart2();
            await runPart3();
            await runPart4();

            testScreen.classList.remove('active');
            endScreen.classList.add('active');
            questionIndicatorHeader.textContent = 'Test Finished';
            timerDisplayHeader.textContent = '';
        }

        async function runPart1() {
            const questions = shuffle([...speakingData.part1]).slice(0, 3);
            for (let i = 0; i < questions.length; i++) {
                const questionHTML = `<p class="test-question-text">${questions[i].prompt.question}</p>`;
                displayContent('I', questionHTML);
                await runTimer(questions[i].prompt.duration, true);
            }
        }
        
        async function runPart2() {
            const highQualityTopics = speakingData.part2.filter(topic => topic.quality !== 'low');
            const topic = shuffle(highQualityTopics)[0];
            const imageHTML = `<div class="test-image-container"><img src="${topic.imageSrc}" alt="Image for Part 2"></div>`;

            for (let i = 0; i < topic.tasks.length; i++) {
                const task = topic.tasks[i];
                const contentHTML = `${imageHTML}<p class="test-question-text">${task.question}</p>`;
                displayContent('II', contentHTML);
                await runTimer(task.duration, true);
            }
        }

        async function runPart3() {
            const highQualityTopics = speakingData.part3.filter(topic => topic.quality !== 'low');
            const topic = shuffle(highQualityTopics)[0];
            const imagesHTML = `<div class="test-image-container">
                                    <img src="${topic.image1Src}" alt="Picture 1">
                                    <img src="${topic.image2Src}" alt="Picture 2">
                                </div>`;
            
            for (let i = 0; i < topic.tasks.length; i++) {
                const task = topic.tasks[i];
                const contentHTML = `${imagesHTML}<p class="test-question-text">${task.question}</p>`;
                displayContent('III', contentHTML);
                await runTimer(task.duration, true);
            }
        }

        async function runPart4() {
            const topic = shuffle([...speakingData.part4])[0];
            let questionsHTML = '<ul>';
            topic.tasks.forEach(task => { questionsHTML += `<li>${task.question}</li>`; });
            questionsHTML += '</ul>';
            const part4Content = `<div class="test-part4-questions">${questionsHTML}</div>`;
            
            // Thời gian chuẩn bị
            displayContent('IV', part4Content);
            timerDisplayHeader.textContent = "Preparation Time: 01:00";
            await runTimer(60); 

            // Thời gian nói
            // Cập nhật lại màn hình để timer chính xác
            partIndicator.textContent = `Speaking IV`;
            questionArea.innerHTML = `
                 <div class="question-content">
                    <p class="question-sub-header">Câu hỏi</p>
                    ${part4Content}
                </div>
            `;
            questionIndicatorHeader.textContent = `Speaking question ${questionCounter}`;
            await runTimer(120, true);
        }

        startBtn.addEventListener('click', startTest);
        nextBtn.addEventListener('click', () => forceNext());
    });
    </script>
</body>
</html>