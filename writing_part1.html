<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing - Part 1</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <header id="header-placeholder"></header>
    <div class="content-pusher">
        <div class="container">
            <div class="page-intro">
                <h1>Writing - Part 1</h1>
                <p>Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ v√† b·∫Øt ƒë·∫ßu luy·ªán t·∫≠p</p>
            </div>

            <!-- H·ªòP GI·∫¢I TH√çCH M·ªöI -->
            <div class="explanation-box">
                <h3>üí° Ph∆∞∆°ng ph√°p h·ªçc & L∆∞u √Ω</h3>
                <p>B·∫°n c√≥ 3 ph√∫t ƒë·ªÉ tr·∫£ l·ªùi 5 c√¢u h·ªèi, m·ªói c√¢u kh√¥ng qu√° 10 t·ª´. H√£y c·ªë g·∫Øng tr·∫£ l·ªùi ng·∫Øn g·ªçn, ƒë√∫ng tr·ªçng
                    t√¢m v√† ƒë√∫ng ng·ªØ ph√°p.</p>
                <p><strong>L∆∞u √Ω:</strong> N·ªôi dung b·∫°n g√µ s·∫Ω ƒë∆∞·ª£c <strong>t·ª± ƒë·ªông l∆∞u</strong> v√†o tr√¨nh duy·ªát c·ªßa b·∫°n
                    (s·ª≠ d·ª•ng Local Storage). N·∫øu b·∫°n v√¥ t√¨nh t·∫£i l·∫°i trang, b√†i l√†m v·∫´n s·∫Ω c√≤n. Tuy nhi√™n, ƒë·ªÉ ch·∫Øc ch·∫Øn,
                    b·∫°n v·∫´n n√™n sao ch√©p b√†i l√†m quan tr·ªçng ra n∆°i kh√°c nh∆∞ l√† Word, Google T√†i li·ªáu r·ªìi l∆∞u l√™n Drive ƒë·ªÉ khi c·∫ßn m√† xem l·∫°i.</p>
            </div>


            <!-- B·∫¢NG ƒêI·ªÄU KHI·ªÇN CH·ªåN CH·ª¶ ƒê·ªÄ -->
            <div id="topic-selector-grid" class="topic-grid">
                <!-- C√°c n√∫t ch·ªçn ch·ªß ƒë·ªÅ s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </div>

            <main id="writing-container">
                <!-- Ch·ªâ m·ªôt b√†i t·∫≠p ƒë∆∞·ª£c hi·ªÉn th·ªã t·∫°i m·ªôt th·ªùi ƒëi·ªÉm -->
            </main>
        </div>
        <footer id="footer-placeholder"></footer>
    </div>
    <script src="js/main.js"></script>
    <script src="js/data-writing.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selectorContainer = document.getElementById('topic-selector-grid');
            const contentContainer = document.getElementById('writing-container');
            const topics = writingData.part1;

            if (!topics || topics.length === 0) {
                contentContainer.innerHTML = `<p class="error">Kh√¥ng c√≥ d·ªØ li·ªáu cho Writing Part 1.</p>`;
                return;
            }

            let activeTimerInterval; // Bi·∫øn ƒë·ªÉ l∆∞u tr·ªØ timer ƒëang ch·∫°y

            // T·∫†O N√öT V√Ä CARD CHO M·ªñI CH·ª¶ ƒê·ªÄ
            topics.forEach((topic, index) => {
                // T·∫°o n√∫t ch·ªçn
                const button = document.createElement('button');
                button.className = 'topic-selector-btn';
                button.textContent = `Ch·ªß ƒë·ªÅ ${index + 1}`;
                button.dataset.target = `#${topic.id}`;
                selectorContainer.appendChild(button);

                // T·∫°o card n·ªôi dung
                const card = document.createElement('div');
                card.className = 'quiz-card writing-card';
                card.id = topic.id;
                const storageKey = `writing_part1_${topic.id}`;

                let questionsHTML = `<div class="card-header"><h2>${topic.title}</h2></div>`;
                topic.questions.forEach((q, i) => {
                    questionsHTML += `
                        <div class="writing-prompt">
                            <label for="${topic.id}-answer-${i}">${i + 1}. ${q}</label>
                            <textarea id="${topic.id}-answer-${i}" rows="2" data-index="${i}" placeholder="Your answer (1-10 words)..."></textarea>
                            <div class="word-count-container"><span class="word-count">0/10 words</span></div>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="writing-timer-bar">
                        <button class="action-btn start-writing-btn">B·∫Øt ƒë·∫ßu t√≠nh gi·ªù (3 ph√∫t)</button>
                        <div class="timer-display">03:00</div>
                    </div>
                    <div class="writing-content">${questionsHTML}</div>`;
                contentContainer.appendChild(card);
            });

            const allButtons = selectorContainer.querySelectorAll('.topic-selector-btn');
            const allCards = contentContainer.querySelectorAll('.writing-card');

            // H√ÄM HI·ªÇN TH·ªä CH·ª¶ ƒê·ªÄ
            function showTopic(targetId) {
                allCards.forEach(card => card.classList.remove('active'));
                allButtons.forEach(btn => btn.classList.remove('active'));

                const targetCard = document.querySelector(targetId);
                const targetButton = selectorContainer.querySelector(`[data-target='${targetId}']`);

                if (targetCard) targetCard.classList.add('active');
                if (targetButton) targetButton.classList.add('active');

                // D·ª´ng timer c≈© n·∫øu c√≥
                if (activeTimerInterval) clearInterval(activeTimerInterval);
                // Reset t·∫•t c·∫£ c√°c timer bar
                allCards.forEach(c => {
                    const btn = c.querySelector('.start-writing-btn');
                    const display = c.querySelector('.timer-display');
                    if (btn) btn.disabled = false;
                    if (btn) btn.textContent = 'B·∫Øt ƒë·∫ßu t√≠nh gi·ªù (3 ph√∫t)';
                    if (display) display.textContent = '03:00';
                });
            }

            // LOGIC L∆ØU V√Ä T·∫¢I B√ÄI
            function loadAnswers(card) {
                const storageKey = `writing_part1_${card.id}`;
                const savedAnswers = JSON.parse(localStorage.getItem(storageKey));
                if (savedAnswers) {
                    savedAnswers.forEach((answer, index) => {
                        const textarea = card.querySelector(`#${card.id}-answer-${index}`);
                        if (textarea) {
                            textarea.value = answer;
                            textarea.dispatchEvent(new Event('input'));
                        }
                    });
                }
            }
            allCards.forEach(loadAnswers); // T·∫£i b√†i l√†m cho t·∫•t c·∫£ c√°c card

            // G√ÅN S·ª∞ KI·ªÜN
            selectorContainer.addEventListener('click', function (e) {
                if (e.target.classList.contains('topic-selector-btn')) showTopic(e.target.dataset.target);
            });

            contentContainer.addEventListener('input', function (e) {
                if (e.target.tagName === 'TEXTAREA') {
                    const card = e.target.closest('.writing-card');
                    const storageKey = `writing_part1_${card.id}`;
                    // C·∫≠p nh·∫≠t ƒë·∫øm t·ª´
                    const wordCountSpan = e.target.nextElementSibling.querySelector('.word-count');
                    const words = e.target.value.trim().split(/\s+/).filter(word => word.length > 0);
                    wordCountSpan.textContent = `${words.length}/10 words`;
                    wordCountSpan.classList.toggle('limit-exceeded', words.length > 10);
                    // L∆∞u b√†i
                    const allTextareas = card.querySelectorAll('textarea');
                    const answersToSave = Array.from(allTextareas).map(ta => ta.value);
                    localStorage.setItem(storageKey, JSON.stringify(answersToSave));
                }
            });

            contentContainer.addEventListener('click', function (e) {
                if (e.target.classList.contains('start-writing-btn')) {
                    if (activeTimerInterval) clearInterval(activeTimerInterval); // D·ª´ng timer kh√°c n·∫øu ƒëang ch·∫°y

                    const button = e.target;
                    const timerBar = button.closest('.writing-timer-bar');
                    const timerDisplay = timerBar.querySelector('.timer-display');
                    const card = button.closest('.writing-card');

                    button.disabled = true;
                    button.textContent = 'ƒêang t√≠nh gi·ªù...';
                    let timeInSeconds = 180;

                    activeTimerInterval = setInterval(() => {
                        timeInSeconds--;
                        const minutes = Math.floor(timeInSeconds / 60);
                        const seconds = timeInSeconds % 60;
                        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        if (timeInSeconds <= 0) {
                            clearInterval(activeTimerInterval);
                            timerDisplay.textContent = "H·∫øt gi·ªù!";
                            alert("H·∫øt gi·ªù l√†m b√†i!");
                            card.querySelectorAll('textarea').forEach(ta => ta.disabled = true);
                        }
                    }, 1000);
                }
            });

            // HI·ªÇN TH·ªä CH·ª¶ ƒê·ªÄ ƒê·∫¶U TI√äN
            if (allButtons.length > 0) showTopic(allButtons[0].dataset.target);
        });
    </script>
</body>

</html>