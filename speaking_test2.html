<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speaking Test Simulation</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="icon" href="img/favicon.png" type="image/x-icon">
</head>

<body>
    <header id="header-placeholder"></header>
    <div class="content-pusher">
        <div class="container">
            <div class="test-simulation-wrapper">

                <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu -->
                <div id="start-screen" class="test-screen active">
                    <h1>M√¥ ph·ªèng b√†i thi Speaking</h1>
                    <p>B√†i thi s·∫Ω ch·∫°y t·ª± ƒë·ªông qua 4 ph·∫ßn. B·∫°n s·∫Ω kh√¥ng th·ªÉ t·∫°m d·ª´ng.</p>
                    <p>H√£y chu·∫©n b·ªã s·∫µn micro ho·∫∑c ƒëi·ªán tho·∫°i ƒë·ªÉ ghi √¢m l·∫°i ph·∫ßn tr·∫£ l·ªùi c·ªßa b·∫°n.</p>
                    <button class="action-btn" id="start-test-btn">B·∫Øt ƒë·∫ßu b√†i thi</button>
                </div>

                <!-- M√†n h√¨nh l√†m b√†i -->
                <div id="test-screen" class="test-screen">
                    <h2 id="part-indicator"></h2>
                    <p id="task-indicator"></p>

                    <div id="question-area">
                        <!-- N·ªôi dung c√¢u h·ªèi/h√¨nh ·∫£nh s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
                    </div>

                    <div id="timer-area">
                        <div id="timer-label"></div>
                        <div id="timer-display"></div>
                        <div class="progress-bar-container">
                            <div id="progress-bar"></div>
                        </div>
                        <!-- TH√äM N√öT M·ªöI V√ÄO ƒê√ÇY -->
                        <button class="action-btn" id="next-btn" style="margin-top: 15px; display: none;">Next Question
                            ‚û°Ô∏è</button>
                    </div>
                </div>

                <!-- M√†n h√¨nh k·∫øt th√∫c (ƒê√É N√ÇNG C·∫§P) -->
                <div id="end-screen" class="test-screen">
                    <h1>B√†i thi ƒë√£ k·∫øt th√∫c!</h1>
                    <p>Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i thi m√¥ ph·ªèng.</p>
                    
                    <!-- T√°i s·ª≠ d·ª•ng giao di·ªán c·ªßa explanation-box -->
                    <div class="explanation-box" style="margin-top: 20px; text-align: left;">
                        <h3>üí° B∆∞·ªõc ti·∫øp theo: T·ª± ƒë√°nh gi√° b√†i l√†m</h3>
                        <p>B√¢y gi·ªù l√† l√∫c s·ª≠ d·ª•ng file ghi √¢m b·∫°n v·ª´a t·∫°o ƒë·ªÉ c·∫£i thi·ªán k·ªπ nƒÉng. H√£y l√†m theo c√°c b∆∞·ªõc sau:</p>
                        <ul>
                            <li><strong>B∆∞·ªõc 1:</strong> Nghe l·∫°i file ghi √¢m c·ªßa b·∫°n.</li>
                            <li><strong>B∆∞·ªõc 2:</strong> So s√°nh c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n v·ªõi c√°c "C√¢u tr·∫£ l·ªùi m·∫´u" trong c√°c trang luy·ªán t·∫≠p ri√™ng l·∫ª.</li>
                            <li><strong>B∆∞·ªõc 3 (N√¢ng cao):</strong> T·∫£i file ghi √¢m (MP3) l√™n c√°c c√¥ng c·ª• AI nh∆∞ Google Gemini, ChatGPT-4o, ho·∫∑c c√°c d·ªãch v·ª• s·ª≠a b√†i n√≥i chuy√™n d·ª•ng ƒë·ªÉ nh·∫≠n feedback chi ti·∫øt v·ªÅ ng·ªØ ph√°p, ph√°t √¢m v√† s·ª± tr√¥i ch·∫£y.</li>
                        </ul>
                    </div>

                    <a href="speaking_test.html" class="action-btn" style="margin-top: 20px;">L√†m l·∫°i b√†i thi kh√°c</a>
                    <a href="index.html" class="action-btn-secondary" style="margin-top: 10px;">Quay v·ªÅ trang ch·ªß</a>
                </div>

            </div>
        </div>
        <footer id="footer-placeholder"></footer>
    </div>
    <script src="js/main.js"></script>
    <script src="js/data-speaking.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // L·∫•y c√°c element
            const startScreen = document.getElementById('start-screen');
            const testScreen = document.getElementById('test-screen');
            const endScreen = document.getElementById('end-screen');
            const startBtn = document.getElementById('start-test-btn');
            const partIndicator = document.getElementById('part-indicator');
            const taskIndicator = document.getElementById('task-indicator');
            const questionArea = document.getElementById('question-area');
            const timerLabel = document.getElementById('timer-label');
            const timerDisplay = document.getElementById('timer-display');
            const progressBar = document.getElementById('progress-bar');
            const nextBtn = document.getElementById('next-btn'); // N√∫t m·ªõi


            // H√†m x√°o tr·ªôn m·∫£ng
            const shuffle = (array) => array.sort(() => Math.random() - 0.5);

            let timerInterval; // Bi·∫øn ƒë·ªÉ l∆∞u interval
            let forceNext = () => { }; // H√†m ƒë·ªÉ b·ªè qua timer

            // --- H√ÄM CH·∫†Y ƒê·ªíNG H·ªí ƒê∆Ø·ª¢C N√ÇNG C·∫§P ---
            function runTimer(totalSeconds, showNextButton = false) {
                return new Promise(resolve => {
                    let secondsLeft = totalSeconds;

                    // Logic c·ªßa n√∫t Next
                    forceNext = () => {
                        clearInterval(timerInterval);
                        nextBtn.style.display = 'none'; // ·∫®n n√∫t ƒëi
                        resolve();
                    };

                    if (showNextButton) {
                        nextBtn.style.display = 'inline-block'; // Hi·ªán n√∫t Next
                    } else {
                        nextBtn.style.display = 'none';
                    }

                    // ... (ph·∫ßn code progress bar v√† hi·ªÉn th·ªã th·ªùi gian gi·ªØ nguy√™n) ...
                    progressBar.style.transition = 'none';
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        progressBar.style.transition = `width ${totalSeconds}s linear`;
                        progressBar.style.width = '0%';
                    }, 100);
                    const updateDisplay = () => {
                        const minutes = Math.floor(secondsLeft / 60);
                        const seconds = secondsLeft % 60;
                        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    };
                    updateDisplay();

                    timerInterval = setInterval(() => {
                        secondsLeft--;
                        updateDisplay();
                        if (secondsLeft <= 0) {
                            forceNext(); // G·ªçi h√†m forceNext khi h·∫øt gi·ªù
                        }
                    }, 1000);
                });
            }

            // H√†m hi·ªÉn th·ªã n·ªôi dung
            function displayContent(part, task, contentHTML) {
                partIndicator.textContent = `Part ${part}`;
                taskIndicator.textContent = task;
                questionArea.innerHTML = contentHTML;
            }

            // --- Lu·ªìng thi ch√≠nh ---
            async function startTest() {
                startScreen.classList.remove('active');
                testScreen.classList.add('active');

                await runPart1();
                await runPart2();
                await runPart3();
                await runPart4();

                testScreen.classList.remove('active');
                endScreen.classList.add('active');
            }

            async function runPart1() {
                const questions = shuffle([...speakingData.part1]).slice(0, 3);
                for (let i = 0; i < questions.length; i++) {
                    displayContent('1', `Question ${i + 1} of 3`, `<p class="test-question-text">${questions[i].prompt.question}</p>`);
                    timerLabel.textContent = "Answer the question";
                    await runTimer(questions[i].prompt.duration, true); // Th√™m 'true' ƒë·ªÉ hi·ªán n√∫t Next
                }
            }
            async function runPart2() {
                // L·ªåC B·ªé C√ÅC CH·ª¶ ƒê·ªÄ CH·∫§T L∆Ø·ª¢NG TH·∫§P
                const highQualityTopics = speakingData.part2.filter(topic => topic.quality !== 'low');
                const topic = shuffle(highQualityTopics)[0];

                const imageHTML = `<div class="test-image-container"><img src="${topic.imageSrc}" alt="Image for Part 2"></div>`;

                // S·ª≠a ·ªü ƒë√¢y: d√πng 'topic.tasks' thay v√¨ 'questions'
                for (let i = 0; i < topic.tasks.length; i++) {
                    const task = topic.tasks[i];
                    displayContent('2', `Task ${i + 1} of 3`,
                        `${imageHTML}
                         <p class="test-question-text">${task.question}</p>`
                    );
                    timerLabel.textContent = "Answer the question";
                    // S·ª≠a ·ªü ƒë√¢y: d√πng 'task.duration'
                    await runTimer(task.duration, true);
                }
            }

            async function runPart3() {
                // L·ªåC B·ªé C√ÅC CH·ª¶ ƒê·ªÄ CH·∫§T L∆Ø·ª¢NG TH·∫§P
                const highQualityTopics = speakingData.part3.filter(topic => topic.quality !== 'low');
                const topic = shuffle(highQualityTopics)[0];
                const imagesHTML = `<div class="test-image-container">
                                        <img src="${topic.image1Src}" alt="Picture 1">
                                        <img src="${topic.image2Src}" alt="Picture 2">
                                    </div>`;

                // S·ª≠a ·ªü ƒë√¢y: d√πng 'topic.tasks' thay v√¨ 'questions'
                for (let i = 0; i < topic.tasks.length; i++) {
                    const task = topic.tasks[i];
                    displayContent('3', `Task ${i + 1} of 3`,
                        `${imagesHTML}
                         <p class="test-question-text">${task.question}</p>`
                    );
                    timerLabel.textContent = "Answer the question";
                    // S·ª≠a ·ªü ƒë√¢y: d√πng 'task.duration'
                    await runTimer(task.duration, true);
                }
            }

            async function runPart4() {
                const topic = shuffle([...speakingData.part4])[0];
                let questionsHTML = '<ul>';
                topic.tasks.forEach(task => { questionsHTML += `<li>${task.question}</li>`; });
                questionsHTML += '</ul>';

                displayContent('4', 'Prepare your answer', `<div class="test-part4-questions">${questionsHTML}</div>`);
                timerLabel.textContent = "Preparation Time";
                await runTimer(60); // Kh√¥ng c√≥ n√∫t Next cho th·ªùi gian chu·∫©n b·ªã

                displayContent('4', 'Answer all three questions', `<div class="test-part4-questions">${questionsHTML}</div>`);
                timerLabel.textContent = "Speaking Time";
                await runTimer(120, true); // C√≥ n√∫t Next cho th·ªùi gian tr·∫£ l·ªùi
            }

            startBtn.addEventListener('click', startTest);
            nextBtn.addEventListener('click', () => forceNext()); // N√∫t Next s·∫Ω g·ªçi h√†m forceNext
        });
    </script>
</body>

</html>