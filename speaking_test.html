<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aptis Speaking Test - Giao di·ªán m·ªõi</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="icon" href="img/favicon.png" type="image/x-icon">

    <style>
        /* === CSS ƒê√É C·∫¨P NH·∫¨T CHO GIAO DI·ªÜN M·ªöI === */
        body,
        html {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        /* Header ƒë∆∞·ª£c thi·∫øt k·∫ø l·∫°i */
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background-color: #ffffff;
            border-top: 4px solid #d9534f;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: 100%;
            box-sizing: border-box;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left {
            font-weight: bold;
            font-size: 1.1em;
            color: #d9534f;
        }

        /* Ti√™u ƒë·ªÅ "Speaking Part X" ·ªü gi·ªØa */
        .header-center {
            font-size: 1.5em;
            font-weight: 500;
            color: #000;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .header-right {
            font-size: 0.95em;
        }

        .container {
            max-width: 960px;
            margin: 20px auto;
            padding: 0 24px;
            box-sizing: border-box;
        }

        .test-simulation-wrapper {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            min-height: 500px;
            position: relative;
        }

        .test-screen {
            display: none;
        }

        .test-screen.active {
            display: block;
        }

        /* B·ªè khung cho khu v·ª±c c√¢u h·ªèi */
        #question-area {
            width: 100%;
            padding-top: 20px;
            text-align: center;
        }

        .test-image-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .test-image-container img {
            width: 45%;
            max-width: 300px;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .test-question-text {
            padding: 16px 0;
            margin: 0;
            font-size: 1.2em;
            line-height: 1.6;
        }

        .test-part4-questions ul {
            list-style-position: inside;
            padding: 16px 0;
            margin: 0 auto;
            font-size: 1.2em;
            text-align: left;
            max-width: 80%;
        }

        .test-part4-questions li {
            padding-bottom: 12px;
        }

        /* Footer ch·ª©a n√∫t Next v√† ƒê·ªìng h·ªì */
        .page-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            position: absolute;
            bottom: 24px;
            right: 24px;
            width: calc(100% - 48px);
        }

        #next-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            background-color: #28a745;
            color: white;
            display: none;
            /* ·∫®n m·∫∑c ƒë·ªãnh */
        }

        #next-btn:hover {
            background-color: #218838;
        }

        /* ƒê·ªìng h·ªì tr√≤n m·ªõi */
        .circular-timer {
            position: relative;
            width: 80px;
            height: 80px;
            margin-left: 20px;
        }

        .circular-timer svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .timer-circle {
            fill: none;
            stroke-width: 8;
        }

        .timer-background {
            stroke: #e6e6e6;
        }

        .timer-progress {
            stroke: #28a745;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
        }

        #timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            font-weight: 500;
        }

        #start-screen,
        #end-screen {
            text-align: center;
            padding: 40px 0;
        }

        .explanation-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .explanation-box ul {
            padding-left: 20px;
        }

        .explanation-box li {
            margin-bottom: 10px;
        }

        a.action-btn,
        a.action-btn-secondary {
            text-decoration: none;
        }

        .action-btn-secondary {
            color: #007bff;
            display: inline-block;
        }
            a {
        text-decoration: none;
        color: black;
    }
    /* === STYLE M·ªöI CHO D√íNG CH√ö TH√çCH === */
#disclaimer-text {
    font-style: italic;
    color: #777;
    font-size: 0.9em;
    margin-top: 20px;
}
    </style>
</head>

<body>
    <!-- HTML kh√¥ng thay ƒë·ªïi nhi·ªÅu, ch·ªß y·∫øu l√† ID v√† class -->
    <header class="test-header">
        <a href="index.html">
            <div><i class="fas fa-home"></i>

                Aptis practice
            </div>
        </a>
        <!-- Ti√™u ƒë·ªÅ ph·∫ßn thi s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ·ªü ƒë√¢y -->
        <div class="header-center" id="part-indicator-header">
            Speaking Test
        </div>
        <div class="header-right" id="question-indicator-header">
        </div>
    </header>

    <div class="container">
        <div class="test-simulation-wrapper">

            <div id="start-screen" class="test-screen active">
                <h1>M√¥ ph·ªèng b√†i thi Speaking</h1>
                <!-- === THAY ƒê·ªîI 1: C·∫≠p nh·∫≠t h∆∞·ªõng d·∫´n === -->
                <p>B√†i thi s·∫Ω ch·∫°y t·ª± ƒë·ªông qua 4 ph·∫ßn. B·∫°n s·∫Ω kh√¥ng th·ªÉ t·∫°m d·ª´ng.<br>H√£y chu·∫©n b·ªã s·∫µn micro ho·∫∑c ƒëi·ªán
                    tho·∫°i ƒë·ªÉ ghi √¢m l·∫°i ph·∫ßn tr·∫£ l·ªùi c·ªßa b·∫°n.<br>
                    <strong>L∆∞u √Ω:</strong> B·∫°n s·∫Ω c√≥ 3 gi√¢y ƒë·ªÉ ƒë·ªçc c√¢u h·ªèi. H√£y b·∫Øt ƒë·∫ßu tr·∫£ l·ªùi ngay sau khi b·∫°n nghe
                    th·∫•y ti·∫øng b√≠p.
                </p>

                <!-- === PH·∫¶N ƒê√É TH√äM V√ÄO === -->
                <div style="margin: 25px 0;">
                    <p style="margin-bottom: 10px;"><strong>Nghe th·ª≠ √¢m thanh b·∫Øt ƒë·∫ßu:</strong></p>
                    <audio controls>
                        <!-- S·ª≠ d·ª•ng c√πng m·ªôt file √¢m thanh v·ªõi ti·∫øng b√≠p trong b√†i thi -->
                        <source src="audio/ring.mp3" type="audio/mpeg">
                        Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.
                    </audio>
                </div>

                <button id="start-test-btn"
                    style="padding: 10px 25px; border: none; border-radius: 5px; font-size: 1em; background-color: #28a745; color: white; cursor: pointer;">B·∫Øt
                    ƒë·∫ßu b√†i thi</button>
            </div>

            <div id="test-screen" class="test-screen">
                <!-- Khu v·ª±c c√¢u h·ªèi kh√¥ng c√≤n H2 v√† c√°c element timer c≈© -->
                <div id="question-area"></div>
            </div>

            <!-- M√†n h√¨nh k·∫øt th√∫c -->
            <div id="end-screen" class="test-screen">
                <h1>B√†i thi ƒë√£ k·∫øt th√∫c!</h1>
                <p>Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i thi m√¥ ph·ªèng.</p>
                <div class="explanation-box" style="margin-top: 20px; text-align: left;">
                    <h3>üí° B∆∞·ªõc ti·∫øp theo: T·ª± ƒë√°nh gi√° b√†i l√†m</h3>
                    <p>B√¢y gi·ªù l√† l√∫c s·ª≠ d·ª•ng file ghi √¢m b·∫°n v·ª´a t·∫°o ƒë·ªÉ c·∫£i thi·ªán k·ªπ nƒÉng. H√£y l√†m theo c√°c b∆∞·ªõc sau:
                    </p>
                    <ul>
                        <li><strong>B∆∞·ªõc 1:</strong> Nghe l·∫°i file ghi √¢m c·ªßa b·∫°n.</li>
                        <li><strong>B∆∞·ªõc 2:</strong> So s√°nh c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n v·ªõi c√°c "C√¢u tr·∫£ l·ªùi m·∫´u".</li>
                        <li><strong>B∆∞·ªõc 3 (N√¢ng cao):</strong> T·∫£i file ghi √¢m l√™n c√°c c√¥ng c·ª• AI ƒë·ªÉ nh·∫≠n feedback chi
                            ti·∫øt.</li>
                    </ul>
                </div>
                <a href="speaking_test.html" class="action-btn" style="margin-top: 20px;">L√†m l·∫°i b√†i thi kh√°c</a>
                <a href="index.html" class="action-btn-secondary" style="margin-top: 10px;">Quay v·ªÅ trang ch·ªß</a>
            </div>

            <!-- Footer m·ªõi ch·ª©a c·∫£ n√∫t Next v√† ƒë·ªìng h·ªì -->
            <footer class="page-footer" id="test-footer" style="display: none;">
                <button id="next-btn">Next</button>
                <div class="circular-timer">
                    <!-- ƒê√É S·ª¨A L·ªñI -->
                    <svg viewBox="0 0 36 36">
                        <path class="timer-circle timer-background"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                        <path class="timer-circle timer-progress" id="timer-progress-circle"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                    </svg>
                    <div id="timer-text">00:00</div>
                </div>
            </footer>
        </div>
    </div>

    <!-- === THAY ƒê·ªîI 1: Th√™m th·∫ª audio === -->
    <audio id="start-sound" preload="auto">
        <source src="audio/ring.mp3" type="audio/mpeg">
    </audio>
    <!-- Script c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c t·∫£i ·ªü ƒë√¢y -->
    <script src="js/data-speaking.js"></script>

    <!-- SCRIPT G·ªêC C·ª¶A B·∫†N ƒê∆Ø·ª¢C CH·ªàNH S·ª¨A ƒê·ªÇ PH√ô H·ª¢P GIAO DI·ªÜN M·ªöI -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const startSound = document.getElementById('start-sound');
            const startScreen = document.getElementById('start-screen');
            const testScreen = document.getElementById('test-screen');
            const endScreen = document.getElementById('end-screen');
            const startBtn = document.getElementById('start-test-btn');
            const questionArea = document.getElementById('question-area');
            const nextBtn = document.getElementById('next-btn');
            const testFooter = document.getElementById('test-footer');
            const partIndicatorHeader = document.getElementById('part-indicator-header');
            const questionIndicatorHeader = document.getElementById('question-indicator-header');
            const timerProgressCircle = document.getElementById('timer-progress-circle');
            const timerText = document.getElementById('timer-text');
            const CIRCLE_LENGTH = timerProgressCircle.getTotalLength();

            const shuffle = (array) => array.sort(() => Math.random() - 0.5);

            let timerInterval;
            let delayTimeout;
            let forceNext = () => { };
            let questionCounter = 0;

            // === THAY ƒê·ªîI 2: T·∫°o h√†m delay c√≥ th·ªÉ b·ªè qua ===
            function runSkippableDelay(ms) {
                return new Promise(resolve => {
                    // `forceNext` b√¢y gi·ªù s·∫Ω ng·∫Øt delay n√†y
                    forceNext = () => {
                        clearTimeout(delayTimeout);
                        resolve();
                    };
                    delayTimeout = setTimeout(resolve, ms);
                });
            }

            function resetTimerDisplay(totalSeconds) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                timerText.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timerProgressCircle.style.transition = 'none';
                timerProgressCircle.style.strokeDashoffset = 0;
            }

            function runTimer(totalSeconds, showNextButton = false) {
                return new Promise(resolve => {
                    let secondsLeft = totalSeconds;
                    // `forceNext` b√¢y gi·ªù s·∫Ω ng·∫Øt ƒë·ªìng h·ªì ch√≠nh
                    forceNext = () => {
                        clearInterval(timerInterval);
                        resolve();
                    };

                    nextBtn.style.display = showNextButton ? 'inline-block' : 'none';

                    const updateDisplay = () => {
                        const minutes = Math.floor(secondsLeft / 60);
                        const seconds = secondsLeft % 60;
                        timerText.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        const progress = secondsLeft / totalSeconds;
                        const dashoffset = CIRCLE_LENGTH * (1 - progress);
                        timerProgressCircle.style.strokeDashoffset = dashoffset;
                    };

                    resetTimerDisplay(totalSeconds);

                    setTimeout(() => {
                        timerProgressCircle.style.transition = `stroke-dashoffset 1s linear`;
                    }, 100);

                    updateDisplay();

                    timerInterval = setInterval(() => {
                        secondsLeft--;
                        updateDisplay();
                        if (secondsLeft < 0) {
                            forceNext();
                        }
                    }, 1000);
                });
            }

            function displayContent(part, task, contentHTML) {
                questionCounter++;
                partIndicatorHeader.textContent = `Speaking Part ${part}`;
                questionArea.innerHTML = contentHTML;
                questionIndicatorHeader.textContent = `Question ${questionCounter}`;
            }

            async function startTest() {
                startScreen.classList.remove('active');
                testScreen.classList.add('active');
                testFooter.style.display = 'flex';
                questionCounter = 0;
                await runPart1();
                await runPart2();
                await runPart3();
                await runPart4();
                testScreen.classList.remove('active');
                endScreen.classList.add('active');
                testFooter.style.display = 'none';
                partIndicatorHeader.textContent = 'Test Finished';
                questionIndicatorHeader.textContent = '';
            }

            // === C·∫≠p nh·∫≠t c√°c h√†m runPart v·ªõi logic m·ªõi ===
            async function runPart1() {
                const questions = shuffle([...speakingData.part1]).slice(0, 3);
                for (let i = 0; i < questions.length; i++) {
                    const duration = questions[i].prompt.duration;
                    displayContent('I', `Question ${i + 1}`, `<p class="test-question-text">${questions[i].prompt.question}</p>`);
                    resetTimerDisplay(duration);
                    nextBtn.style.display = 'inline-block'; // Hi·ªÉn th·ªã n√∫t Next ngay l·∫≠p t·ª©c

                    await runSkippableDelay(3000); // Ch·ªù 3 gi√¢y (c√≥ th·ªÉ b·ªè qua)

                    await startSound.play().catch(e => console.error("Audio play failed:", e)); // Ph√°t ti·∫øng b√≠p
                    await runTimer(duration, true);
                }
            }

            async function runPart2() {
                const topic = shuffle([...speakingData.part2])[0];
                const imageHTML = `<div class="test-image-container"><img src="${topic.imageSrc}" alt="Image for Part 2"></div>`;
                for (let i = 0; i < topic.tasks.length; i++) {
                    const task = topic.tasks[i];
                    const duration = task.duration;
                    const contentHTML = `${imageHTML}<p class="test-question-text">${task.question}</p>`;
                    displayContent('II', `Task ${i + 1}`, contentHTML);
                    resetTimerDisplay(duration);
                    nextBtn.style.display = 'inline-block';

                    await runSkippableDelay(3000);

                    await startSound.play().catch(e => console.error("Audio play failed:", e));
                    await runTimer(duration, true);
                }
            }

            async function runPart3() {
                const topic = shuffle([...speakingData.part3])[0];
                const imagesHTML = `<div class="test-image-container">...</div>`;
                for (let i = 0; i < topic.tasks.length; i++) {
                    const task = topic.tasks[i];
                    const duration = task.duration;
                    const contentHTML = `${imagesHTML.replace('...', `<img src="${topic.image1Src}" alt="Picture 1"><img src="${topic.image2Src}" alt="Picture 2">`)}<p class="test-question-text">${task.question}</p>`;
                    displayContent('III', `Task ${i + 1}`, contentHTML);
                    resetTimerDisplay(duration);
                    nextBtn.style.display = 'inline-block';

                    await runSkippableDelay(3000);

                    await startSound.play().catch(e => console.error("Audio play failed:", e));
                    await runTimer(duration, true);
                }
            }

            // Part 4 gi·ªØ nguy√™n logic c≈©
            async function runPart4() {
                const topic = shuffle([...speakingData.part4])[0];
                let questionsHTML = '<ul class="test-part4-questions">';
                topic.tasks.forEach(task => { questionsHTML += `<li>${task.question}</li>`; });
                questionsHTML += '</ul>';
                displayContent('IV', 'Prepare your answer', questionsHTML);
                await runTimer(60, false); // Th·ªùi gian chu·∫©n b·ªã, kh√¥ng c√≥ n√∫t Next

                await startSound.play().catch(e => console.error("Audio play failed:", e));
                displayContent('IV', 'Answer all questions', questionsHTML);
                await runTimer(120, true);
            }

            startBtn.addEventListener('click', startTest);
            nextBtn.addEventListener('click', () => forceNext());
        });
    </script>
</body>

</html>