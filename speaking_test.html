<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aptis Speaking Test</title>
    <!-- B·∫°n c√≥ th·ªÉ gi·ªØ ho·∫∑c x√≥a c√°c link n√†y v√¨ CSS ƒë√£ ƒë∆∞·ª£c nh√∫ng b√™n d∆∞·ªõi -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="img/favicon.png" type="image/x-icon">

    <style>
        /* === CSS NH√öNG ƒê·∫∂C BI·ªÜT ƒê·ªÇ T√ÅI T·∫†O GIAO DI·ªÜN APTIS === */

        /* C√†i ƒë·∫∑t chung */
        body,
        html {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        /* Header c·ªßa trang thi */
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background-color: #ffffff;
            border-top: 4px solid #d9534f;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: 100%;
            box-sizing: border-box;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-left {
            font-weight: bold;
            font-size: 1.1em;
        }

        .header-left .icon {
            color: #d9534f;
            margin-right: 8px;
        }

        .header-center, .header-right {
            font-size: 0.95em;
        }

        /* Container ch√≠nh */
        .container {
            max-width: 960px;
            margin: 20px auto;
            padding: 0 24px;
            box-sizing: border-box;
        }
        
        /* Box ch·ª©a n·ªôi dung thi (ph·ªèng theo ·∫£nh) */
        .test-simulation-wrapper {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            min-height: 400px;
        }

        /* ·∫®n/Hi·ªán c√°c m√†n h√¨nh */
        .test-screen {
            display: none;
        }
        .test-screen.active {
            display: block;
        }
        
        /* Ti√™u ƒë·ªÅ ch√≠nh c·ªßa t·ª´ng ph·∫ßn */
        #part-indicator {
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 24px;
            color: #000;
            font-weight: 500;
        }
        
        #task-indicator {
            display: none;
        }
        
        /* Khu v·ª±c h√¨nh ·∫£nh - ƒë∆∞·ª£c t·∫°o b·ªüi JS c·ªßa b·∫°n */
        .test-image-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
        }
        .test-image-container img {
            width: 45%;
            max-width: 300px;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* B·∫£ng c√¢u h·ªèi ƒë∆∞·ª£c m√¥ ph·ªèng */
        #question-area {
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        #question-area::before {
            content: 'C√¢u h·ªèi';
            display: block;
            padding: 16px;
            text-align: left;
            background-color: #f8f9fa;
            font-weight: 500;
            border-bottom: 1px solid #e0e0e0;
        }
        
        /* C√¢u h·ªèi (ƒë∆∞·ª£c t·∫°o b·ªüi JS c·ªßa b·∫°n) */
        .test-question-text {
            padding: 16px;
            margin: 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .test-question-text:last-of-type {
             border-bottom: none;
        }

        .test-part4-questions ul {
            list-style-position: inside;
            padding: 16px;
            margin: 0;
        }
        .test-part4-questions li {
            padding-bottom: 8px;
        }

        /* Footer v√† n√∫t b·∫•m */
        .page-footer {
            display: flex;
            justify-content: flex-end;
            padding: 24px 24px 24px 0;
            padding-top: 16px;
            background-color: transparent;
        }

        .action-btn,
        #next-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            background-color: #28a745;
            color: white;
            display: inline-block;
        }

        .action-btn:hover,
        #next-btn:hover {
            background-color: #218838;
        }
        
        #timer-area {
            display: none;
        }
        
        #start-screen, #end-screen {
            text-align: center;
            padding: 40px 0;
        }
        #start-screen h1, #end-screen h1 {
            margin-bottom: 20px;
        }
        #start-screen p, #end-screen p {
            margin-bottom: 30px;
            color: #555;
            line-height: 1.6;
        }
        
        .explanation-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .explanation-box ul {
            padding-left: 20px;
        }
        .explanation-box li {
            margin-bottom: 10px;
        }
        a.action-btn, a.action-btn-secondary {
             text-decoration: none;
        }
        .action-btn-secondary {
             color: #007bff;
             display: inline-block;
        }
    </style>
</head>

<body>
    <!-- Header tƒ©nh m√¥ ph·ªèng theo ·∫£nh -->
    <header class="test-header">
        <div class="header-left">
            <span class="icon">Aptis practice</span> 
        </div>
        <div class="header-center" id="timer-display-header">
            Time remaining: --:--
        </div>
        <div class="header-right" id="question-indicator-header">
            Speaking Test
        </div>
    </header>

    <!-- N·ªôi dung ch√≠nh m√† SCRIPT c·ªßa b·∫°n s·∫Ω ƒëi·ªÅu khi·ªÉn -->
    <div class="container">
        <div class="test-simulation-wrapper">

            <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu -->
            <div id="start-screen" class="test-screen active">
                <h1>M√¥ ph·ªèng b√†i thi Speaking</h1>
                <p>B√†i thi s·∫Ω ch·∫°y t·ª± ƒë·ªông qua 4 ph·∫ßn. B·∫°n s·∫Ω kh√¥ng th·ªÉ t·∫°m d·ª´ng.<br>H√£y chu·∫©n b·ªã s·∫µn micro ho·∫∑c ƒëi·ªán tho·∫°i ƒë·ªÉ ghi √¢m l·∫°i ph·∫ßn tr·∫£ l·ªùi c·ªßa b·∫°n.</p>
                <button class="action-btn" id="start-test-btn">B·∫Øt ƒë·∫ßu b√†i thi</button>
            </div>

            <!-- M√†n h√¨nh l√†m b√†i (V·ªè r·ªóng ƒë·ªÉ JS c·ªßa b·∫°n ƒëi·ªÅn v√†o) -->
            <div id="test-screen" class="test-screen">
                <h2 id="part-indicator"></h2>
                <p id="task-indicator"></p>
                <div id="question-area"></div>
                <div id="timer-area">
                    <div id="timer-label"></div>
                    <div id="timer-display"></div>
                    <div class="progress-bar-container">
                        <div id="progress-bar"></div>
                    </div>
                </div>
            </div>

            <!-- M√†n h√¨nh k·∫øt th√∫c -->
            <div id="end-screen" class="test-screen">
                <h1>B√†i thi ƒë√£ k·∫øt th√∫c!</h1>
                <p>Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i thi m√¥ ph·ªèng.</p>
                <div class="explanation-box" style="margin-top: 20px; text-align: left;">
                    <h3>üí° B∆∞·ªõc ti·∫øp theo: T·ª± ƒë√°nh gi√° b√†i l√†m</h3>
                    <p>B√¢y gi·ªù l√† l√∫c s·ª≠ d·ª•ng file ghi √¢m b·∫°n v·ª´a t·∫°o ƒë·ªÉ c·∫£i thi·ªán k·ªπ nƒÉng. H√£y l√†m theo c√°c b∆∞·ªõc sau:</p>
                    <ul>
                        <li><strong>B∆∞·ªõc 1:</strong> Nghe l·∫°i file ghi √¢m c·ªßa b·∫°n.</li>
                        <li><strong>B∆∞·ªõc 2:</strong> So s√°nh c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n v·ªõi c√°c "C√¢u tr·∫£ l·ªùi m·∫´u".</li>
                        <li><strong>B∆∞·ªõc 3 (N√¢ng cao):</strong> T·∫£i file ghi √¢m l√™n c√°c c√¥ng c·ª• AI ƒë·ªÉ nh·∫≠n feedback chi ti·∫øt.</li>
                    </ul>
                </div>
                 <a href="speaking_test.html" class="action-btn" style="margin-top: 20px;">L√†m l·∫°i b√†i thi kh√°c</a>
                 <a href="index.html" class="action-btn-secondary" style="margin-top: 10px;">Quay v·ªÅ trang ch·ªß</a>
            </div>

        </div>
         <footer class="page-footer">
            <button class="action-btn" id="next-btn" style="display: none;">Next</button>
        </footer>
    </div>
    
    <script src="js/data-speaking.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // L·∫•y c√°c element
        const startScreen = document.getElementById('start-screen');
        const testScreen = document.getElementById('test-screen');
        const endScreen = document.getElementById('end-screen');
        const startBtn = document.getElementById('start-test-btn');
        const partIndicator = document.getElementById('part-indicator');
        const taskIndicator = document.getElementById('task-indicator');
        const questionArea = document.getElementById('question-area');
        const timerLabel = document.getElementById('timer-label');
        const timerDisplay = document.getElementById('timer-display');
        const progressBar = document.getElementById('progress-bar');
        const nextBtn = document.getElementById('next-btn');
        const timerDisplayHeader = document.getElementById('timer-display-header');
        const questionIndicatorHeader = document.getElementById('question-indicator-header');

        const shuffle = (array) => array.sort(() => Math.random() - 0.5);

        let timerInterval;
        let forceNext = () => {};
        let questionCounter = 0;

        function runTimer(totalSeconds, showNextButton = false) {
            return new Promise(resolve => {
                let secondsLeft = totalSeconds;
                forceNext = () => {
                    clearInterval(timerInterval);
                    nextBtn.style.display = 'none';
                    resolve();
                };
                if (showNextButton) {
                    nextBtn.style.display = 'inline-block';
                } else {
                    nextBtn.style.display = 'none';
                }
                const updateDisplay = () => {
                    const minutes = Math.floor(secondsLeft / 60);
                    const seconds = secondsLeft % 60;
                    const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    timerDisplay.textContent = formattedTime;
                    timerDisplayHeader.textContent = `Time remaining: ${formattedTime}`;
                };
                updateDisplay();
                progressBar.style.transition = 'none';
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.transition = `width ${totalSeconds}s linear`;
                    progressBar.style.width = '0%';
                }, 100);
                timerInterval = setInterval(() => {
                    secondsLeft--;
                    updateDisplay();
                    if (secondsLeft <= 0) {
                        forceNext();
                    }
                }, 1000);
            });
        }

        function displayContent(part, task, contentHTML) {
            questionCounter++;
            partIndicator.textContent = `Speaking ${part}`;
            taskIndicator.textContent = task;
            questionArea.innerHTML = contentHTML;
            questionIndicatorHeader.textContent = `Speaking question ${questionCounter}`;
        }
        
        async function startTest() {
            startScreen.classList.remove('active');
            testScreen.classList.add('active');
            document.querySelector('.page-footer').style.display = 'flex';
            questionCounter = 0; // Reset counter

            await runPart1();
            await runPart2();
            await runPart3();
            await runPart4();

            testScreen.classList.remove('active');
            endScreen.classList.add('active');
            document.querySelector('.page-footer').style.display = 'none';
            questionIndicatorHeader.textContent = 'Test Finished';
        }

        async function runPart1() {
            const questions = shuffle([...speakingData.part1]).slice(0, 3);
            for (let i = 0; i < questions.length; i++) {
                const questionHTML = `<p class="test-question-text">${questions[i].prompt.question}</p>`;
                displayContent('I', `Question ${i + 1} of 3`, questionHTML);
                await runTimer(questions[i].prompt.duration, true);
            }
        }
        
        async function runPart2() {
            const highQualityTopics = speakingData.part2.filter(topic => topic.quality !== 'low');
            const topic = shuffle(highQualityTopics)[0];
            const imageHTML = `<div class="test-image-container"><img src="${topic.imageSrc}" alt="Image for Part 2"></div>`;

            for (let i = 0; i < topic.tasks.length; i++) {
                const task = topic.tasks[i];
                const contentHTML = `${imageHTML}<p class="test-question-text">${task.question}</p>`;
                displayContent('II', `Task ${i + 1} of 3`, contentHTML);
                await runTimer(task.duration, true);
            }
        }

        // *** ƒê√É S·ª¨A L·∫†I H√ÄM N√ÄY ***
        async function runPart3() {
            const highQualityTopics = speakingData.part3.filter(topic => topic.quality !== 'low');
            const topic = shuffle(highQualityTopics)[0];
            const imagesHTML = `<div class="test-image-container">
                                    <img src="${topic.image1Src}" alt="Picture 1">
                                    <img src="${topic.image2Src}" alt="Picture 2">
                                </div>`;
            
            // L·∫∑p qua t·ª´ng c√¢u h·ªèi, hi·ªÉn th·ªã l·∫ßn l∆∞·ª£t
            for (let i = 0; i < topic.tasks.length; i++) {
                const task = topic.tasks[i];
                // G·ªôp HTML c·ªßa 2 ·∫£nh v√† 1 c√¢u h·ªèi hi·ªán t·∫°i
                const contentHTML = `${imagesHTML}<p class="test-question-text">${task.question}</p>`;
                displayContent('III', `Task ${i + 1} of 3`, contentHTML);
                // Ch·∫°y timer cho ri√™ng c√¢u h·ªèi n√†y
                await runTimer(task.duration, true);
            }
        }

        async function runPart4() {
            const topic = shuffle([...speakingData.part4])[0];
            let questionsHTML = '<ul>';
            topic.tasks.forEach(task => { questionsHTML += `<li>${task.question}</li>`; });
            questionsHTML += '</ul>';
            const part4Content = `<div class="test-part4-questions">${questionsHTML}</div>`;
            
            // Th·ªùi gian chu·∫©n b·ªã
            displayContent('IV', 'Prepare your answer', part4Content);
            timerDisplayHeader.textContent = "Preparation Time: 01:00";
            await runTimer(60); 

            // Th·ªùi gian n√≥i
            // C·∫≠p nh·∫≠t l·∫°i m√†n h√¨nh ƒë·ªÉ timer ch√≠nh x√°c
            partIndicator.textContent = `Speaking IV`;
            questionArea.innerHTML = part4Content;
            questionIndicatorHeader.textContent = `Speaking question ${questionCounter}`;
            await runTimer(120, true);
        }

        startBtn.addEventListener('click', startTest);
        nextBtn.addEventListener('click', () => forceNext());
    });
    </script>
</body>
</html>