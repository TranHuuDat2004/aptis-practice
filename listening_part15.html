<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listening - Part 2 (C√¢u 15)</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
</head>

<body>
    <header id="header-placeholder"></header>
    <div class="content-pusher">
        <div class="container">
            <div class="page-intro">
                <h1>Listening - Luy·ªán t·∫≠p C√¢u 15</h1>
                <p>N·ªëi c√¢u h·ªèi v·ªõi ng∆∞·ªùi n√≥i (Woman, Man, Both)</p>
            </div>
            <div class="explanation-box">
                <h3>üí° Quy lu·∫≠t v√†ng c·ªßa C√¢u 15</h3>
                <p>Nhi·ªám v·ª• l√† n·ªëi 4 √Ω ki·∫øn v·ªõi ng∆∞·ªùi n√≥i (Woman, Man, Both). ƒêi·ªÉm m·∫•u ch·ªët l√† th·ª© t·ª± n√≥i chuy·ªán:</p>
                <ul>
                    <li>N·∫øu <strong>Woman n√≥i tr∆∞·ªõc</strong>, key s·∫Ω l√† key g·ªëc (v√≠ d·ª•: W-B-M-B).</li>
                    <li>N·∫øu <strong>Man n√≥i tr∆∞·ªõc</strong>, key s·∫Ω b·ªã <strong>ƒë·∫£o ng∆∞·ª£c</strong>: W th√†nh M, M th√†nh W,
                        c√≤n B gi·ªØ nguy√™n (v√≠ d·ª•: W-B-M-B ‚ûî M-B-W-B).</li>
                </ul>
                <p>H√£y s·ª≠ d·ª•ng c√¥ng t·∫Øc b√™n d∆∞·ªõi ƒë·ªÉ luy·ªán t·∫≠p quy lu·∫≠t n√†y cho t·ª´ng ch·ªß ƒë·ªÅ.</p>
            </div>

            

            <main id="quiz-container">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </main>
        </div>
        <footer id="footer-placeholder"></footer>
    </div>
    <script src="js/main.js"></script>
    <script src="js/data-listening.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const quizContainer = document.getElementById('quiz-container');
            const topics = listeningData.part15;

            topics.forEach((topic, index) => {
                const button = document.createElement('button');
                button.className = 'topic-selector-btn';
                button.textContent = `Ch·ªß ƒë·ªÅ ${index + 1}`;
                button.dataset.target = `#${topic.id}`;
                

                const card = document.createElement('div');
                card.className = 'quiz-card part4-card';
                card.id = topic.id;
                card.dataset.baseKey = topic.baseKey;
                if (topic.isFixed) card.dataset.isFixed = "true";

                let questionsHTML = '';
                for (let i = 1; i <= 4; i++) {
                    questionsHTML += `
                        <div class="part4-question" data-question-index="${i - 1}">
                            <p><strong>C√¢u ${i}</strong></p>
                            <div class="part4-options">
                                <button class="option-btn" data-choice="W">W</button>
                                <button class="option-btn" data-choice="M">M</button>
                                <button class="option-btn" data-choice="B">B</button>
                            </div>
                        </div>
                    `;
                }

                const toggleDisabled = topic.isFixed ? 'disabled' : '';
                card.innerHTML = `
                    <div class="card-header">
                        <h2>${topic.title}</h2>
                        <div class="speaker-toggle-container ${toggleDisabled ? 'disabled' : ''}">
                            <span>Woman</span>
                            <label class="switch"><input type="checkbox" class="speaker-toggle" ${toggleDisabled}><span class="slider round"></span></label>
                            <span>Man</span>
                        </div>
                    </div>
                    <div class="part4-questions-container">${questionsHTML}</div>
                    <div class="feedback-message"></div>
                    <div class="card-actions">
                        <button class="action-btn check-answer-btn">Ki·ªÉm tra ƒë√°p √°n</button>
                        <button class="action-btn show-story-btn">Xem Key & G·ª£i nh·ªõ</button>
                    </div>
                    <div class="answer-section" style="display: none;">
                        <h4>ƒê√°p √°n & G·ª£i nh·ªõ</h4>
                        <p><strong>Key ƒë√∫ng:</strong> <span class="final-key-display"></span></p>
                        <p><strong>C√¢u chuy·ªán g·ª£i nh·ªõ:</strong> ${topic.story}</p>
                    </div>
                `;
                quizContainer.appendChild(card);
            });

            // --- LOGIC HO√ÄN CH·ªàNH V√Ä ƒê√ÅNG TIN C·∫¨Y ---
    
            const allCards = quizContainer.querySelectorAll('.part4-card');

            function showTopic(targetId) {
                allCards.forEach(card => card.classList.remove('active'));
                allButtons.forEach(btn => btn.classList.remove('active'));
                const targetCard = document.querySelector(targetId);
                const targetButton = selectorContainer.querySelector(`[data-target='${targetId}']`);
                if (targetCard) targetCard.classList.add('active');
                if (targetButton) targetButton.classList.add('active');
            }

            function calculateKeyArray(baseKey, isManFirst, isFixed) {
                const keyArray = baseKey.split('-');
                if (isManFirst && !isFixed) {
                    return keyArray.map(char => {
                        if (char === 'W') return 'M';
                        if (char === 'M') return 'W';
                        return 'B';
                    });
                }
                return keyArray;
            }

            // 1. Th√™m s·ª± ki·ªán 'change' cho c√¥ng t·∫Øc toggle
            quizContainer.addEventListener('change', function(e) {
                if (e.target.classList.contains('speaker-toggle')) {
                    const card = e.target.closest('.part4-card');
                    const answerSection = card.querySelector('.answer-section');
                    
                    // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu ƒë√°p √°n ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã
                    if (answerSection.style.display === 'block') {
                        const isManFirst = e.target.checked;
                        const isFixed = card.dataset.isFixed === "true";
                        const baseKey = card.dataset.baseKey;
                        
                        const finalKeyArray = calculateKeyArray(baseKey, isManFirst, isFixed);
                        card.querySelector('.final-key-display').textContent = finalKeyArray.join(' - ');
                    }
                }
            });
            
            quizContainer.addEventListener('click', function (e) {
                if (e.target.classList.contains('option-btn')) {
                    const parentOptions = e.target.parentElement;
                    parentOptions.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                }

                if (e.target.classList.contains('check-answer-btn')) {
                    const card = e.target.closest('.part4-card');
                    const isManFirst = card.querySelector('.speaker-toggle').checked;
                    const isFixed = card.dataset.isFixed === "true";
                    const baseKey = card.dataset.baseKey;

                    const correctKeyArray = calculateKeyArray(baseKey, isManFirst, isFixed);

                    let correctCount = 0;
                    const questions = card.querySelectorAll('.part4-question');
                    questions.forEach((q, i) => {
                        const selectedBtn = q.querySelector('.option-btn.selected');
                        q.classList.remove('correct', 'incorrect');
                        if (selectedBtn && selectedBtn.dataset.choice === correctKeyArray[i]) {
                            q.classList.add('correct');
                            correctCount++;
                        } else if (selectedBtn) {
                            q.classList.add('incorrect');
                        }
                    });
                    card.querySelector('.feedback-message').innerHTML = `ƒê√∫ng: <strong>${correctCount}/${questions.length}</strong>`;
                }

                if (e.target.classList.contains('show-story-btn')) {
                    const card = e.target.closest('.part4-card');
                    const isManFirst = card.querySelector('.speaker-toggle').checked;
                    const isFixed = card.dataset.isFixed === "true";
                    const baseKey = card.dataset.baseKey;

                    const finalKeyArray = calculateKeyArray(baseKey, isManFirst, isFixed);
                    card.querySelector('.final-key-display').textContent = finalKeyArray.join(' - ');

                    const answerSection = e.target.closest('.card-actions').nextElementSibling;
                    const isVisible = answerSection.style.display === 'block';
                    answerSection.style.display = isVisible ? 'none' : 'block';
                    e.target.textContent = isVisible ? '·∫®n Key & G·ª£i nh·ªõ' : 'Xem Key & G·ª£i nh·ªõ';
                }
            });

            
           
        });
    </script>
</body>


</html>